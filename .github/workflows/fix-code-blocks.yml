name: Fix Code Blocks Daily

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ 9:00 æ‰§è¡Œ (UTC+8 = UTC 01:00)
    - cron: '0 1 * * *'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main
    paths:
      - 'docs/**/*.md'
      - 'content/**/*.md'

jobs:
  fix-code-blocks:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
          
      - name: Install dependencies
        run: bun install
        
      - name: Fix code blocks
        run: |
          echo "å¼€å§‹ä¿®å¤ä»£ç å—..." >> $GITHUB_STEP_SUMMARY
          bun run fix-code-blocks 2>&1 | tee fix_output.log
          echo "ä¿®å¤å®Œæˆï¼ŒæŸ¥çœ‹è¯¦ç»†æ—¥å¿—..." >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -20 fix_output.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        
      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet docs/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ä¿®æ”¹çš„æ–‡ä»¶:" >> $GITHUB_STEP_SUMMARY
            git diff --name-only docs/ >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/
          git commit -m "ðŸ”§ è‡ªåŠ¨ä¿®å¤ä»£ç å—æ ¼å¼ (@@filename å’Œ @@switch)"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Create summary
        run: |
          echo "## ä»£ç å—ä¿®å¤ç»“æžœ ðŸ”§" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.changes.outputs.has_changes }}" == "true" ]]; then
            echo "âœ… å‘çŽ°å¹¶ä¿®å¤äº†ä»£ç å—æ ¼å¼é—®é¢˜" >> $GITHUB_STEP_SUMMARY
            echo "- å°† \`@@filename()\` è½¬æ¢ä¸º rspress è¯­æ³•" >> $GITHUB_STEP_SUMMARY
            echo "- åˆ é™¤äº† \`@@switch\` åŽçš„ JavaScript ä»£ç å—" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… æ‰€æœ‰ä»£ç å—æ ¼å¼éƒ½æ˜¯æ­£ç¡®çš„ï¼Œæ— éœ€ä¿®å¤" >> $GITHUB_STEP_SUMMARY
          fi
