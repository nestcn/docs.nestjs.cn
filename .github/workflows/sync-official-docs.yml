      - name: Update sync time badge JSON (Gist)
        if: steps.sync-content.outputs.content_changed == 'true' || steps.translate-content.outputs.translation_changed == 'true' || steps.sync-assets.outputs.assets_changed == 'true'
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: |
          SYNC_TIME=$(date -u '+%Y-%m-%d')
          cat > sync-summary.json <<EOF
          {
            "schemaVersion": 1,
            "label": "sync-docs",
            "message": "$SYNC_TIME",
            "color": "brightgreen"
          }
          EOF
          gist_id="b3a004684a48178741a9ab9e1a90ab3e"
          file_name="nestjscn-sync-time.json"
          curl -X PATCH "https://api.github.com/gists/$gist_id" \
            -H "Authorization: token $GIST_TOKEN" \
            -d "{\"files\": {\"$file_name\": {\"content\": $(jq -Rs . < sync-summary.json)}}}"
name: Sync Official NestJS Docs

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 02:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰
    - cron: '0 2 * * *'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main
    paths:
      - '.github/workflows/sync-official-docs.yml'

jobs:
  sync-docs:
    runs-on: ubuntu-latest
    
    env:
      # Cloudflare Workers AI é…ç½®
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
    
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Clone official NestJS docs repository
        run: |
          git clone --depth 1 https://github.com/nestjs/docs.nestjs.com.git official-docs

      - name: Compare and sync content folder
        id: sync-content
        run: |
          if [ ! -d "official-docs/content" ]; then
            echo "âŒ å®˜æ–¹ä»“åº“ä¸­æœªæ‰¾åˆ° content æ–‡ä»¶å¤¹"
            exit 1
          fi
          
          echo "ğŸ” æ­£åœ¨æ¯”è¾ƒ content æ–‡ä»¶å¤¹..."
          CONTENT_CHANGED=false
          
          # æ£€æŸ¥ content æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨å·®å¼‚
          if [ -d "content" ]; then
            # ä½¿ç”¨ rsync çš„ dry-run æ¨¡å¼æ£€æŸ¥å·®å¼‚
            if ! rsync -avu --dry-run --delete official-docs/content/ content/ > /tmp/content-diff.log 2>&1; then
              CONTENT_CHANGED=true
            elif [ -s /tmp/content-diff.log ]; then
              # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…çš„æ–‡ä»¶å·®å¼‚ï¼ˆè¿‡æ»¤æ‰ä»…æœ‰çš„æ—¶é—´æˆ³å·®å¼‚ï¼‰
              if grep -E "^(deleting|>|<|\*)" /tmp/content-diff.log > /dev/null; then
                CONTENT_CHANGED=true
              fi
            fi
          else
            echo "ğŸ“ æœ¬åœ°ä¸å­˜åœ¨ content æ–‡ä»¶å¤¹ï¼Œå°†åˆ›å»º"
            CONTENT_CHANGED=true
          fi
          
          if [ "$CONTENT_CHANGED" = true ]; then
            echo "ğŸ“‹ æ£€æµ‹åˆ°å†…å®¹å˜æ›´ï¼š"
            cat /tmp/content-diff.log || echo "åˆå§‹åŒæ­¥ - æ— å·®å¼‚æ—¥å¿—å¯ç”¨"
            
            # å¤‡ä»½ç°æœ‰å†…å®¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -d "content" ]; then
              echo "ğŸ’¾ æ­£åœ¨å¤‡ä»½å½“å‰å†…å®¹..."
              mv content content-backup-$(date +%Y%m%d-%H%M%S)
            fi
            
            # åŒæ­¥æ–°å†…å®¹
            echo "ğŸ”„ æ­£åœ¨åŒæ­¥ content æ–‡ä»¶å¤¹..."
            cp -r official-docs/content ./
            echo "âœ… content æ–‡ä»¶å¤¹åŒæ­¥æˆåŠŸ"
            echo "content_changed=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… content æ–‡ä»¶å¤¹å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ”¹"
            echo "content_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Compare and sync assets folder
        id: sync-assets
        run: |
          ASSETS_CHANGED=false
          
          if [ -d "official-docs/src/assets" ]; then
            echo "ğŸ” æ­£åœ¨æ¯”è¾ƒ assets æ–‡ä»¶å¤¹..."
            
            # åˆ›å»º public ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            mkdir -p public
            
            # æ£€æŸ¥ assets æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨å·®å¼‚
            if [ -d "public/assets" ]; then
              # ä½¿ç”¨ rsync çš„ dry-run æ¨¡å¼æ£€æŸ¥å·®å¼‚
              if ! rsync -avu --dry-run --delete official-docs/src/assets/ public/assets/ > /tmp/assets-diff.log 2>&1; then
                ASSETS_CHANGED=true
              elif [ -s /tmp/assets-diff.log ]; then
                # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…çš„æ–‡ä»¶å·®å¼‚
                if grep -E "^(deleting|>|<|\*)" /tmp/assets-diff.log > /dev/null; then
                  ASSETS_CHANGED=true
                fi
              fi
            else
              echo "ğŸ“ æœ¬åœ°ä¸å­˜åœ¨ assets æ–‡ä»¶å¤¹ï¼Œå°†åˆ›å»º"
              ASSETS_CHANGED=true
            fi
            
            if [ "$ASSETS_CHANGED" = true ]; then
              echo "ğŸ“‹ æ£€æµ‹åˆ°èµ„æºå˜æ›´ï¼š"
              cat /tmp/assets-diff.log || echo "åˆå§‹åŒæ­¥ - æ— å·®å¼‚æ—¥å¿—å¯ç”¨"
              
              # åŒæ­¥æ–°èµ„æº
              echo "ğŸ”„ æ­£åœ¨åŒæ­¥ assets æ–‡ä»¶å¤¹..."
              rsync -av --delete official-docs/src/assets/ public/assets/
              echo "âœ… assets æ–‡ä»¶å¤¹åŒæ­¥æˆåŠŸ"
              echo "assets_changed=true" >> $GITHUB_OUTPUT
            else
              echo "âœ… assets æ–‡ä»¶å¤¹å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ”¹"
              echo "assets_changed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ å®˜æ–¹ä»“åº“ä¸­æœªæ‰¾åˆ° assets æ–‡ä»¶å¤¹ï¼Œè·³è¿‡..."
            echo "assets_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Clean up
        run: |
          rm -rf official-docs

      - name: Process and translate content changes
        id: translate-content
        if: steps.sync-content.outputs.content_changed == 'true'
        run: |
          echo "ğŸ”„ æ­£åœ¨å¤„ç†å†…å®¹å˜æ›´å¹¶è¿›è¡Œç¿»è¯‘..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„ Cloudflare é…ç½®
          if [ -n "$CLOUDFLARE_API_TOKEN" ] && [ -n "$CLOUDFLARE_ACCOUNT_ID" ]; then
            echo "âœ… Cloudflare Workers AI å·²é…ç½®ï¼Œä½¿ç”¨ AI ç¿»è¯‘"
            if bun run translate-docs:verbose; then
              echo "âœ… ç¿»è¯‘å®Œæˆï¼Œæœ‰å†…å®¹æ›´æ–°"
              echo "translation_changed=true" >> $GITHUB_OUTPUT
            else
              TRANSLATION_EXIT_CODE=$?
              if [ $TRANSLATION_EXIT_CODE -eq 1 ]; then
                echo "âœ… ç¿»è¯‘å®Œæˆï¼Œä½†æ— éœ€æ›´æ–°"
                echo "translation_changed=false" >> $GITHUB_OUTPUT
              else
                echo "âŒ ç¿»è¯‘å¤±è´¥ï¼Œé€€å‡ºä»£ç  $TRANSLATION_EXIT_CODE"
                echo "translation_changed=error" >> $GITHUB_OUTPUT
                exit 1
              fi
            fi
          else
            echo "âš ï¸ æœªé…ç½® Cloudflare API å‡­æ®ï¼Œä½¿ç”¨ä»…æ ¼å¼åŒ–æ¨¡å¼"
            if bun run translate-docs:no-ai; then
              echo "âœ… æ ¼å¼å¤„ç†å®Œæˆï¼Œæœ‰å†…å®¹æ›´æ–°"
              echo "translation_changed=true" >> $GITHUB_OUTPUT
            else
              TRANSLATION_EXIT_CODE=$?
              if [ $TRANSLATION_EXIT_CODE -eq 1 ]; then
                echo "âœ… æ ¼å¼å¤„ç†å®Œæˆï¼Œä½†æ— éœ€æ›´æ–°"
                echo "translation_changed=false" >> $GITHUB_OUTPUT
              else
                echo "âŒ æ ¼å¼å¤„ç†å¤±è´¥ï¼Œé€€å‡ºä»£ç  $TRANSLATION_EXIT_CODE"
                echo "translation_changed=error" >> $GITHUB_OUTPUT
                exit 1
              fi
            fi
          fi

      - name: Fix code blocks and template syntax
        if: steps.translate-content.outputs.translation_changed == 'true'
        run: |
          echo "ğŸ”§ æ­£åœ¨è¿è¡Œä»£ç å—å’Œæ¨¡æ¿è¯­æ³•ä¿®å¤..."
          bun run fix-all
          echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"

      - name: Update README sync time and check for changes
        id: changes
        run: |
          # å¦‚æœæœ‰å†…å®¹åŒæ­¥æˆ–ç¿»è¯‘æ›´æ–°ï¼Œæ›´æ–° README ä¸­çš„åŒæ­¥æ—¶é—´
          if [ "${{ steps.sync-content.outputs.content_changed }}" == "true" ] || [ "${{ steps.translate-content.outputs.translation_changed }}" == "true" ] || [ "${{ steps.sync-assets.outputs.assets_changed }}" == "true" ]; then
            echo "ğŸ“… æ­£åœ¨æ›´æ–° README.md ä¸­çš„åŒæ­¥æ—¶é—´..."
            
            # è·å–å½“å‰æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰- æ ¼å¼: 2025å¹´07æœˆ01æ—¥ 17:48
            SYNC_TIME=$(TZ='Asia/Shanghai' date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M')
            
            # æ›´æ–° README.md ä¸­çš„åŒæ­¥æ—¶é—´æ ‡è®°
            sed -i "s|<!-- LAST_SYNC_TIME -->.*<!-- /LAST_SYNC_TIME -->|<!-- LAST_SYNC_TIME --> $SYNC_TIME <!-- /LAST_SYNC_TIME -->|g" README.md
            
            echo "âœ… åŒæ­¥æ—¶é—´å·²æ›´æ–°ä¸º: $SYNC_TIME"
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤
          git add .
          if git diff --cached --quiet; then
            echo "æœªæ£€æµ‹åˆ°å˜æ›´"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "æ£€æµ‹åˆ°å˜æ›´"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # è¾“å‡ºå˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
            echo "ğŸ“‹ å˜æ›´çš„æ–‡ä»¶ï¼š"
            git diff --cached --name-status
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          # ç”Ÿæˆè¯¦ç»†çš„æäº¤ä¿¡æ¯
          COMMIT_MSG="ğŸ”„ Sync official NestJS docs content and assets"
          
          if [ "${{ steps.sync-content.outputs.content_changed }}" == "true" ]; then
            COMMIT_MSG="${COMMIT_MSG}

          ğŸ“ Content changes detected and synced"
          fi
          
          if [ "${{ steps.translate-content.outputs.translation_changed }}" == "true" ]; then
            COMMIT_MSG="${COMMIT_MSG}

          ğŸŒ Translations updated with Cloudflare Workers AI"
          fi
          
          if [ "${{ steps.sync-assets.outputs.assets_changed }}" == "true" ]; then
            COMMIT_MSG="${COMMIT_MSG}

          ğŸ¨ Assets changes detected and synced"
          fi
          
          # æ·»åŠ åŒæ­¥ä¿¡æ¯
          COMMIT_MSG="${COMMIT_MSG}

          ğŸ•’ Sync date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          ğŸ“¦ Source: https://github.com/nestjs/docs.nestjs.com"
          
          git commit -m "$COMMIT_MSG"
          git push

      - name: Create summary
        run: |
          echo "## ğŸ“‹ åŒæ­¥æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **åŒæ­¥æ—¥æœŸ**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **æºä»“åº“**: https://github.com/nestjs/docs.nestjs.com" >> $GITHUB_STEP_SUMMARY
          
          # Content åŒæ­¥çŠ¶æ€
          if [ "${{ steps.sync-content.outputs.content_changed }}" == "true" ]; then
            echo "- **å†…å®¹åŒæ­¥**: âœ… æ˜¯ï¼ˆæ£€æµ‹åˆ°å˜æ›´å¹¶åº”ç”¨ï¼‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **å†…å®¹åŒæ­¥**: âœ… å·²æ˜¯æœ€æ–°ï¼ˆæ— éœ€æ›´æ”¹ï¼‰" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ç¿»è¯‘çŠ¶æ€
          if [ "${{ steps.translate-content.outputs.translation_changed }}" == "true" ]; then
            echo "- **ç¿»è¯‘æ›´æ–°**: âœ… æ˜¯ï¼ˆä½¿ç”¨ Cloudflare Workers AI æ›´æ–°äº† docs æ–‡ä»¶å¤¹ï¼‰" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.translate-content.outputs.translation_changed }}" == "false" ]; then
            echo "- **ç¿»è¯‘æ›´æ–°**: âœ… å·²æ˜¯æœ€æ–°ï¼ˆæ— éœ€ç¿»è¯‘æ›´æ”¹ï¼‰" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.sync-content.outputs.content_changed }}" == "true" ]; then
            echo "- **ç¿»è¯‘æ›´æ–°**: âš ï¸ å†…å®¹å·²å˜æ›´ä½†è·³è¿‡äº†ç¿»è¯‘" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **ç¿»è¯‘æ›´æ–°**: â– æ— å†…å®¹å˜æ›´éœ€è¦ç¿»è¯‘" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Assets åŒæ­¥çŠ¶æ€
          if [ "${{ steps.sync-assets.outputs.assets_changed }}" == "true" ]; then
            echo "- **èµ„æºåŒæ­¥**: âœ… æ˜¯ï¼ˆæ£€æµ‹åˆ°å˜æ›´å¹¶åº”ç”¨ï¼‰" >> $GITHUB_STEP_SUMMARY
          elif [ -d "public/assets" ]; then
            echo "- **èµ„æºåŒæ­¥**: âœ… å·²æ˜¯æœ€æ–°ï¼ˆæ— éœ€æ›´æ”¹ï¼‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **èµ„æºåŒæ­¥**: âš ï¸ æºä¸­æœªæ‰¾åˆ°" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Git æäº¤çŠ¶æ€
          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "- **å˜æ›´æäº¤**: âœ… æ˜¯ï¼Œå˜æ›´å·²æäº¤å¹¶æ¨é€" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **å˜æ›´æäº¤**: âŒ æ— å˜æ›´éœ€è¦æäº¤" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "## âŒ åŒæ­¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "åŒæ­¥æ“ä½œå¤±è´¥ã€‚è¯·æ£€æŸ¥æ—¥å¿—äº†è§£è¯¦ç»†ä¿¡æ¯ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "æ‚¨å¯ä»¥æ‰‹åŠ¨é‡æ–°è§¦å‘æ­¤å·¥ä½œæµæˆ–è°ƒæŸ¥é—®é¢˜ã€‚" >> $GITHUB_STEP_SUMMARY
