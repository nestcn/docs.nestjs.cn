name: Sync Official NestJS Docs

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 02:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰
    - cron: '0 2 * * *'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main
    paths:
      - '.github/workflows/sync-official-docs.yml'

jobs:
  sync-docs:
    runs-on: ubuntu-latest
    
    env:
      # Cloudflare Workers AI é…ç½®
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
    
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Clone official NestJS docs repository
        run: |
          git clone --depth 1 https://github.com/nestjs/docs.nestjs.com.git official-docs

      - name: Compare and sync content folder
        id: sync-content
        run: |
          if [ ! -d "official-docs/content" ]; then
            echo "âŒ Content folder not found in official repository"
            exit 1
          fi
          
          echo "ğŸ” Comparing content folder..."
          CONTENT_CHANGED=false
          
          # æ£€æŸ¥ content æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨å·®å¼‚
          if [ -d "content" ]; then
            # ä½¿ç”¨ rsync çš„ dry-run æ¨¡å¼æ£€æŸ¥å·®å¼‚
            if ! rsync -avu --dry-run --delete official-docs/content/ content/ > /tmp/content-diff.log 2>&1; then
              CONTENT_CHANGED=true
            elif [ -s /tmp/content-diff.log ]; then
              # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…çš„æ–‡ä»¶å·®å¼‚ï¼ˆè¿‡æ»¤æ‰ä»…æœ‰çš„æ—¶é—´æˆ³å·®å¼‚ï¼‰
              if grep -E "^(deleting|>|<|\*)" /tmp/content-diff.log > /dev/null; then
                CONTENT_CHANGED=true
              fi
            fi
          else
            echo "ğŸ“ Content folder does not exist locally, will create"
            CONTENT_CHANGED=true
          fi
          
          if [ "$CONTENT_CHANGED" = true ]; then
            echo "ğŸ“‹ Content changes detected:"
            cat /tmp/content-diff.log || echo "Initial sync - no diff available"
            
            # å¤‡ä»½ç°æœ‰å†…å®¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -d "content" ]; then
              echo "ğŸ’¾ Backing up current content..."
              mv content content-backup-$(date +%Y%m%d-%H%M%S)
            fi
            
            # åŒæ­¥æ–°å†…å®¹
            echo "ğŸ”„ Syncing content folder..."
            cp -r official-docs/content ./
            echo "âœ… Content folder synced successfully"
            echo "content_changed=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Content folder is up to date, no changes needed"
            echo "content_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Compare and sync assets folder
        id: sync-assets
        run: |
          ASSETS_CHANGED=false
          
          if [ -d "official-docs/src/assets" ]; then
            echo "ğŸ” Comparing assets folder..."
            
            # åˆ›å»º public ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            mkdir -p public
            
            # æ£€æŸ¥ assets æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨å·®å¼‚
            if [ -d "public/assets" ]; then
              # ä½¿ç”¨ rsync çš„ dry-run æ¨¡å¼æ£€æŸ¥å·®å¼‚
              if ! rsync -avu --dry-run --delete official-docs/src/assets/ public/assets/ > /tmp/assets-diff.log 2>&1; then
                ASSETS_CHANGED=true
              elif [ -s /tmp/assets-diff.log ]; then
                # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…çš„æ–‡ä»¶å·®å¼‚
                if grep -E "^(deleting|>|<|\*)" /tmp/assets-diff.log > /dev/null; then
                  ASSETS_CHANGED=true
                fi
              fi
            else
              echo "ğŸ“ Assets folder does not exist locally, will create"
              ASSETS_CHANGED=true
            fi
            
            if [ "$ASSETS_CHANGED" = true ]; then
              echo "ğŸ“‹ Assets changes detected:"
              cat /tmp/assets-diff.log || echo "Initial sync - no diff available"
              
              # åŒæ­¥æ–°èµ„æº
              echo "ğŸ”„ Syncing assets folder..."
              rsync -av --delete official-docs/src/assets/ public/assets/
              echo "âœ… Assets folder synced successfully"
              echo "assets_changed=true" >> $GITHUB_OUTPUT
            else
              echo "âœ… Assets folder is up to date, no changes needed"
              echo "assets_changed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ Assets folder not found in official repository, skipping..."
            echo "assets_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Clean up
        run: |
          rm -rf official-docs

      - name: Process and translate content changes
        id: translate-content
        if: steps.sync-content.outputs.content_changed == 'true'
        run: |
          echo "ğŸ”„ Processing content changes for translation..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„ Cloudflare é…ç½®
          if [ -n "$CLOUDFLARE_API_TOKEN" ] && [ -n "$CLOUDFLARE_ACCOUNT_ID" ]; then
            echo "âœ… Cloudflare Workers AI configured, using AI translation"
            if bun run translate-docs:verbose; then
              echo "âœ… Translation completed with changes"
              echo "translation_changed=true" >> $GITHUB_OUTPUT
            else
              TRANSLATION_EXIT_CODE=$?
              if [ $TRANSLATION_EXIT_CODE -eq 1 ]; then
                echo "âœ… Translation completed but no changes needed"
                echo "translation_changed=false" >> $GITHUB_OUTPUT
              else
                echo "âŒ Translation failed with exit code $TRANSLATION_EXIT_CODE"
                echo "translation_changed=error" >> $GITHUB_OUTPUT
                exit 1
              fi
            fi
          else
            echo "âš ï¸ Cloudflare API credentials not configured, using format-only mode"
            if bun run translate-docs:no-ai; then
              echo "âœ… Format processing completed with changes"
              echo "translation_changed=true" >> $GITHUB_OUTPUT
            else
              TRANSLATION_EXIT_CODE=$?
              if [ $TRANSLATION_EXIT_CODE -eq 1 ]; then
                echo "âœ… Format processing completed but no changes needed"
                echo "translation_changed=false" >> $GITHUB_OUTPUT
              else
                echo "âŒ Format processing failed with exit code $TRANSLATION_EXIT_CODE"
                echo "translation_changed=error" >> $GITHUB_OUTPUT
                exit 1
              fi
            fi
          fi

      - name: Fix code blocks and template syntax
        if: steps.translate-content.outputs.translation_changed == 'true'
        run: |
          echo "ğŸ”§ Running code block and template syntax fixes..."
          bun run fix-all
          echo "âœ… Code formatting completed"

      - name: Update README sync time and check for changes
        id: changes
        run: |
          # å¦‚æœæœ‰å†…å®¹åŒæ­¥æˆ–ç¿»è¯‘æ›´æ–°ï¼Œæ›´æ–° README ä¸­çš„åŒæ­¥æ—¶é—´
          if [ "${{ steps.sync-content.outputs.content_changed }}" == "true" ] || [ "${{ steps.translate-content.outputs.translation_changed }}" == "true" ] || [ "${{ steps.sync-assets.outputs.assets_changed }}" == "true" ]; then
            echo "ğŸ“… Updating sync time in README.md..."
            
            # è·å–å½“å‰æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰- æ ¼å¼: 2025å¹´07æœˆ01æ—¥ 17:48
            SYNC_TIME=$(TZ='Asia/Shanghai' date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M')
            
            # æ›´æ–° README.md ä¸­çš„åŒæ­¥æ—¶é—´æ ‡è®°
            sed -i "s|<!-- LAST_SYNC_TIME -->.*<!-- /LAST_SYNC_TIME -->|<!-- LAST_SYNC_TIME --> $SYNC_TIME <!-- /LAST_SYNC_TIME -->|g" README.md
            
            echo "âœ… Sync time updated to: $SYNC_TIME"
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤
          git add .
          if git diff --cached --quiet; then
            echo "No changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # è¾“å‡ºå˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
            echo "ğŸ“‹ Changed files:"
            git diff --cached --name-status
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          # ç”Ÿæˆè¯¦ç»†çš„æäº¤ä¿¡æ¯
          COMMIT_MSG="ğŸ”„ Sync official NestJS docs content and assets"
          
          if [ "${{ steps.sync-content.outputs.content_changed }}" == "true" ]; then
            COMMIT_MSG="${COMMIT_MSG}

          ğŸ“ Content changes detected and synced"
          fi
          
          if [ "${{ steps.translate-content.outputs.translation_changed }}" == "true" ]; then
            COMMIT_MSG="${COMMIT_MSG}

          ğŸŒ Translations updated with Cloudflare Workers AI"
          fi
          
          if [ "${{ steps.sync-assets.outputs.assets_changed }}" == "true" ]; then
            COMMIT_MSG="${COMMIT_MSG}

          ğŸ¨ Assets changes detected and synced"
          fi
          
          # æ·»åŠ åŒæ­¥ä¿¡æ¯
          COMMIT_MSG="${COMMIT_MSG}

          ğŸ•’ Sync date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          ğŸ“¦ Source: https://github.com/nestjs/docs.nestjs.com"
          
          git commit -m "$COMMIT_MSG"
          git push

      - name: Create summary
        run: |
          echo "## ğŸ“‹ Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Sync Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Source Repository**: https://github.com/nestjs/docs.nestjs.com" >> $GITHUB_STEP_SUMMARY
          
          # Content åŒæ­¥çŠ¶æ€
          if [ "${{ steps.sync-content.outputs.content_changed }}" == "true" ]; then
            echo "- **Content Synced**: âœ… Yes (changes detected and applied)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Content Synced**: âœ… Up to date (no changes needed)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ç¿»è¯‘çŠ¶æ€
          if [ "${{ steps.translate-content.outputs.translation_changed }}" == "true" ]; then
            echo "- **Translation Updated**: âœ… Yes (docs folder updated with Cloudflare Workers AI)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.translate-content.outputs.translation_changed }}" == "false" ]; then
            echo "- **Translation Updated**: âœ… Up to date (no translation changes needed)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.sync-content.outputs.content_changed }}" == "true" ]; then
            echo "- **Translation Updated**: âš ï¸ Content changed but translation skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Translation Updated**: â– No content changes to translate" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Assets åŒæ­¥çŠ¶æ€
          if [ "${{ steps.sync-assets.outputs.assets_changed }}" == "true" ]; then
            echo "- **Assets Synced**: âœ… Yes (changes detected and applied)" >> $GITHUB_STEP_SUMMARY
          elif [ -d "public/assets" ]; then
            echo "- **Assets Synced**: âœ… Up to date (no changes needed)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Assets Synced**: âš ï¸ Not found in source" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Git æäº¤çŠ¶æ€
          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "- **Changes Committed**: âœ… Yes, changes committed and pushed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Changes Committed**: âŒ No changes to commit" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "## âŒ Sync Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The sync operation failed. Please check the logs for details." >> $GITHUB_STEP_SUMMARY
          echo "You can manually trigger this workflow again or investigate the issue." >> $GITHUB_STEP_SUMMARY
